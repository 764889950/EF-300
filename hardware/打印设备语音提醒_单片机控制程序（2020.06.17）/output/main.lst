C51 COMPILER V9.52.0.0   MAIN                                                              06/17/2020 14:26:54 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\output\main.obj
COMPILER INVOKED BY: D:\Keil_c51\C51\BIN\C51.EXE src\main.c BROWSE DEBUG OBJECTEXTEND PRINT(.\output\main.lst) TABS(2) O
                    -BJECT(.\output\main.obj)

line level    source

   1          /*********************************************************************************************************
             -*********
   2                  
   3                        +--------------------------------------------------+
   4                                       主函数部分
   5                        +--------------------------------------------------+
   6          
   7           - 实现功能：
   8          
   9           - 目前进展：
  10           - 日期    ：2020-06-08
  11          
  12           - 作者    ：
  13          
  14           - 运行环境：STC   晶振：22.1184M     波特率:9600
  15          
  16           - 备注    ：在ASR M08语音模块上上调试OK --- STC11L16XE+
  17           
  18           1、实现芯片上电分别指定播放第一曲和第二曲，基本的程序供用户测试
  19           2、该测试程序必须是模块或者芯片方案中，有设备在线，譬如U盘、TF卡、FLASH等等
  20           3、
  21          **********************************************************************************************************
             -********/
  22          #include "STK6037.h"
  23          
  24          static INT8U Send_buf[10] = {0} ;
  25          static INT8U Recv_buf[10] = {0} ;
  26          
  27          
  28          /*****************************************************************************************************
  29           - 功能描述：10us的延时函数
  30           - 隶属模块：常用函数库(内部)
  31           - 参数说明：无
  32           - 返回参数：无
  33           - 注： 在这里的运行环境是51,晶振为12MHZ    
  34          *****************************************************************************************************/
  35          void Delay_Us(INT32U z)
  36          {
  37   1        while(z--);
  38   1      }
  39          
  40          /***********************毫秒级别延时************************/
  41          
  42          void Delay_Ms(INT32U z)
  43          {
  44   1        INT32U x=0 , y=0;
  45   1        for(x=110 ; x>0 ;x--)
  46   1        for(y=z; y>0;y-- );
  47   1      }
  48          
  49          /*****************************************************************************************************
  50           - 功能描述： 串口1初始化
  51           - 隶属模块： 外部
  52           - 参数说明： 无
C51 COMPILER V9.52.0.0   MAIN                                                              06/17/2020 14:26:54 PAGE 2   

  53           - 返回说明： 无
  54           - 注：       22.1184MHz晶振下，都是9600波特率
  55          *****************************************************************************************************/
  56          void UartConfiguration()
  57          {
  58   1        TMOD=0x20;     
  59   1        TH1=0xfa;     
  60   1        TL1=0xfa;   
  61   1        PCON=0x00;     
  62   1        SCON=0x50;    
  63   1        EA=1; 
  64   1        ES=1; 
  65   1        TR1=1;
  66   1      }
  67          /********************************************************************************************
  68           - 功能描述： 串口发送一个字节
  69           - 隶属模块： 外部
  70           - 参数说明：
  71           - 返回说明：
  72           - 注：       
  73          ********************************************************************************************/
  74          void Uart_PutByte(INT8U ch)
  75          {
  76   1          SBUF  = ch;
  77   1          while(!TI);
  78   1          TI = 0;
  79   1      }
  80          
  81          /*****************************************************************************************************
  82           - 功能描述： 串口发送一帧数据
  83           - 隶属模块： 内部 
  84           - 参数说明： 
  85           - 返回说明： 
  86           - 注：无     
  87          *****************************************************************************************************/
  88          void SendCmd(INT8U len)
  89          {
  90   1        INT8U i = 0 ;
  91   1        Uart_PutByte(0x7E); //起始
  92   1        for(i=0; i<len; i++)//数据
  93   1        {
  94   2          Uart_PutByte(Send_buf[i]) ;
  95   2        }
  96   1        Uart_PutByte(0xEF) ;//结束
  97   1      }
  98          
  99          /********************************************************************************************
 100           - 功能描述：求和校验
 101           - 隶属模块：
 102           - 参数说明：
 103           - 返回说明：
 104           - 注：      和校验的思路如下
 105                       发送的指令，去掉起始和结束。将中间的6个字节进行累加，最后取反码
 106                       接收端就将接收到的一帧数据，去掉起始和结束。将中间的数据累加，再加上接收到的校验
 107                       字节。刚好为0.这样就代表接收到的数据完全正确。
 108          ********************************************************************************************/
 109          void DoSum( INT8U *Str, INT8U len)
 110          {
 111   1          INT16U xorsum = 0;
 112   1          INT8U i;
 113   1      
 114   1          for(i=0; i<len; i++)
C51 COMPILER V9.52.0.0   MAIN                                                              06/17/2020 14:26:54 PAGE 3   

 115   1          {
 116   2              xorsum  = xorsum + Str[i];
 117   2          }
 118   1        xorsum     = 0 -xorsum;
 119   1        *(Str+i)   = (INT8U)(xorsum >>8);
 120   1        *(Str+i+1) = (INT8U)(xorsum & 0x00ff);
 121   1      }
 122          
 123          
 124          /********************************************************************************************
 125           - 功能描述： 串口向外发送命令[包括控制和查询]
 126           - 隶属模块： 外部
 127           - 参数说明： CMD:表示控制指令，请查阅指令表，还包括查询的相关指令
 128                        feedback:是否需要应答[0:不需要应答，1:需要应答]
 129                        data:传送的参数
 130           - 返回说明：
 131           - 注：       
 132          ********************************************************************************************/
 133          void Uart_SendCMD(INT8U CMD ,INT8U feedback , INT16U dat)
 134          {
 135   1          Send_buf[0] = 0xff;    //保留字节 
 136   1          Send_buf[1] = 0x06;    //长度
 137   1          Send_buf[2] = CMD;     //控制指令
 138   1          Send_buf[3] = feedback;//是否需要反馈
 139   1          Send_buf[4] = (INT8U)(dat >> 8);//datah
 140   1          Send_buf[5] = (INT8U)(dat);     //datal
 141   1          DoSum(&Send_buf[0],6);        //校验
 142   1          SendCmd(8);       //发送此帧数据
 143   1      }
 144          
 145          static INT8U date;
 146          
 147          void main()
 148          { 
 149   1        P1=0x00;
 150   1        Delay_Ms(3000) ;
 151   1      
 152   1        UartConfiguration();
 153   1        
 154   1        while(1)
 155   1        {
 156   2          if(P1==0x01)//P1.0为高电平时，进入控制
 157   2          {
 158   3            resend_1:
 159   3            Uart_SendCMD(0x12 , 0 , 0x01) ;//播放TF卡中 "中"0001"曲目,0001打印已完成
 160   3            Delay_Ms(30000) ;
 161   3            Delay_Ms(30000) ;
 162   3      
 163   3            if(date!=0xEF)
 164   3            {
 165   4              goto resend_1;
 166   4            }
 167   3            date=0;
 168   3          }
 169   2          
 170   2          if(P1==0x10)//P1.1为高电平时，进入控制
 171   2          {   
 172   3            resend_2:
 173   3            Uart_SendCMD(0x12 , 0 , 0x02) ;//播放TF卡中 "MP3"中"0002"曲目，,0002打印仓门未关
 174   3            Delay_Ms(30000) ;
 175   3            Delay_Ms(30000) ;
 176   3      
C51 COMPILER V9.52.0.0   MAIN                                                              06/17/2020 14:26:54 PAGE 4   

 177   3            if(date!=0xEF)
 178   3            {
 179   4              goto resend_2;
 180   4            }
 181   3            date=0;
 182   3          }
 183   2        }
 184   1      }
 185          
 186          void Uart() interrupt 4
 187          {
 188   1        if(RI==1)
 189   1        {
 190   2          date=SBUF; 
 191   2          RI=0; 
 192   2        }
 193   1      }
 194          
 195          //7E FF 06 3D 00 00 08 FE B6 EF 7E FF 06 3D 00 00 08 FE B6 EF 
 196          //7E FF 06 3D 00 00 07 FE B7 EF 7E FF 06 3D 00 00 07 FE B7 EF 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    299    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     21       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
